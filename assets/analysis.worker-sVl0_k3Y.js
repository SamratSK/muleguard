const Ee=m=>{const f=[];let l="",h=!1;for(let p=0;p<m.length;p+=1){const _=m[p];if(_==='"'){h&&m[p+1]==='"'?(l+='"',p+=1):h=!h;continue}if(_===","&&!h){f.push(l),l="";continue}l+=_}return f.push(l),f},Me=m=>{const f=m.trim().split(/\r?\n/).filter(Boolean);if(f.length<2)return[];const l=Ee(f[0]).map(y=>y.trim()),h=l.indexOf("sender_id"),p=l.indexOf("receiver_id"),_=l.indexOf("transaction_id"),g=l.indexOf("amount"),b=l.indexOf("timestamp");return h===-1||p===-1?[]:f.slice(1).map(y=>{const c=Ee(y).map(o=>o.trim());return{transaction_id:c[_]??"",sender_id:c[h]??"",receiver_id:c[p]??"",amount:c[g]??"",timestamp:c[b]??""}})},K=self;let Q=null,D=[],J=null,V=null,X=null,Y=null,k=null;const Ae=async()=>(Q||(Q=(async()=>{const m=await import("./muling_wasm-BT_7aCSW.js");await m.default(),J=m.analyze_stub,V=m.detect_fan_in,X=m.detect_fan_out,Y=m.detect_cycles,k=m.detect_shell_chains})()),Q);K.onmessage=async m=>{const f=performance.now(),{csvText:l,rows:h,source:p="abc.csv",mode:_="replace"}=m.data;try{await Ae();const g=(h??Me(l??"")).filter(e=>e.sender_id&&e.receiver_id);_==="replace"?D=g:g.length>0&&(D=D.concat(g));const b=D,y=new Set,c=[];b.forEach(e=>{y.add(e.sender_id),y.add(e.receiver_id),c.push({sender:e.sender_id,receiver:e.receiver_id,amount:Number.parseFloat(e.amount||"0")||0,timestamp:e.timestamp?Date.parse(e.timestamp):NaN})});const o=Array.from(y),w=new Map,$=new Map,v=new Map;o.forEach(e=>{w.set(e,0),$.set(e,new Set),v.set(e,new Set)}),c.forEach(e=>{var t,n,s,i;if(w.set(e.sender,(w.get(e.sender)??0)+1),w.set(e.receiver,(w.get(e.receiver)??0)+1),(t=v.get(e.sender))==null||t.add(e.receiver),(n=v.get(e.receiver))==null||n.add(e.sender),Number.isFinite(e.timestamp)){const r=new Date(e.timestamp).toISOString().slice(0,10);(s=$.get(e.sender))==null||s.add(r),(i=$.get(e.receiver))==null||i.add(r)}});const j=[...c.map(e=>e.amount).filter(e=>Number.isFinite(e))].sort((e,t)=>e-t),Z=j.length===0?0:j[Math.floor(j.length/2)],ee=Z>0?Z*.5:0,d=e=>{var i,r;const t=w.get(e)??0,n=((i=v.get(e))==null?void 0:i.size)??0,s=((r=$.get(e))==null?void 0:r.size)??0;return t>=200&&n>=50&&s>=20},L=new Map;o.forEach((e,t)=>L.set(e,t));const M=new Uint32Array(c.length),A=new Uint32Array(c.length),z=new Float64Array(c.length),U=new Float64Array(c.length),te=new Uint32Array(o.length);c.forEach((e,t)=>{M[t]=L.get(e.sender)??0,A[t]=L.get(e.receiver)??0,z[t]=e.timestamp,U[t]=e.amount}),o.forEach((e,t)=>{te[t]=w.get(e)??0});const ne=new Set,G=[],se=[];if(Y){const e=Y(o.length,M,A,3,5,1500,60);let t=[];for(let n=0;n<e.length;n+=1){const s=e[n];if(s===4294967295){t.length>=3&&(t.forEach(r=>ne.add(r)),t.some(r=>d(r))||(G.push(`${t.join(" → ")} → ${t[0]}`),se.push([...t]))),t=[];continue}t.push(o[s])}}const ie=new Set,re=new Set,P=[],W=[],ae=4320*60*1e3,x=new Map,I=new Map;if(V&&X){const e=V(o.length,M,A,z,U,ee,ae,10),t=X(o.length,M,A,z,U,ee,ae,10);for(let n=0;n<e.length;n+=2){const s=o[e[n]],i=o[e[n+1]];x.has(s)||x.set(s,new Set),x.get(s).add(i)}x.forEach((n,s)=>{d(s)||(ie.add(s),P.push(`${s} ← ${Array.from(n).join(", ")}`))});for(let n=0;n<t.length;n+=2){const s=o[t[n]],i=o[t[n+1]];I.has(s)||I.set(s,new Set),I.get(s).add(i)}I.forEach((n,s)=>{d(s)||(re.add(s),W.push(`${s} → ${Array.from(n).join(", ")}`))})}const oe=new Set,ce=new Set,me=new Set,le=new Set,B=[];if(!k)throw new Error("WASM shell detection not loaded. Rebuild WASM.");const q=[];if(k){const e=k(o.length,M,A,te,5,2e3,60);let t=[];for(let n=0;n<e.length;n+=1){const s=e[n];if(s===4294967295){if(t.length>=4){const i=t.slice(1,-1);if(!i.some(a=>d(a))){i.forEach((S,E)=>{E===0?oe.add(S):E===1?ce.add(S):me.add(S)});const a=`${t.join(" → ")}`;le.has(a)||(le.add(a),B.push(a),q.push([...t]))}}t=[];continue}t.push(o[s])}}const be={cycle:Array.from(ne).filter(e=>!d(e)),fanIn:Array.from(ie).filter(e=>!d(e)),fanOut:Array.from(re).filter(e=>!d(e)),stage1:Array.from(oe).filter(e=>!d(e)),stage2:Array.from(ce).filter(e=>!d(e)),stage3:Array.from(me).filter(e=>!d(e))},T=[],de=new Set,fe=[],F=(e,t,n,s)=>{const i=t.filter(S=>!d(S));if(i.length===0)return;const r=[...new Set(i)].sort(),a=`${e}:${r.join("|")}`;de.has(a)||(de.add(a),fe.push({key:a,pattern:e,members:r,base:n,display:s}))};se.forEach(e=>F("cycle",e,90,`${e.join(" → ")} → ${e[0]}`)),q.forEach(e=>F("shell_chain",e,85)),x.forEach((e,t)=>F("fan_in",[t,...e],70)),I.forEach((e,t)=>F("fan_out",[t,...e],70));const ue={};fe.sort((e,t)=>e.pattern===t.pattern?e.key.localeCompare(t.key):e.pattern.localeCompare(t.pattern)).forEach((e,t)=>{const n=`RING_${String(t+1).padStart(3,"0")}`;T.push({ring_id:n,member_accounts:e.members,pattern_type:e.pattern,risk_score:Math.min(100,e.base+Math.min(20,e.members.length*2))}),e.display&&(ue[n]=e.display)});const N=new Map,H=new Map;T.forEach(e=>{e.member_accounts.forEach(t=>{N.has(t)||N.set(t,new Set),N.get(t).add(e.pattern_type);const n=H.get(t);(!n||e.risk_score>n.risk)&&H.set(t,{ring_id:e.ring_id,risk:e.risk_score})})});const xe=e=>e==="cycle"?"cycle_length_3_5":e==="fan_in"?"fan_in_10_plus_72h":e==="fan_out"?"fan_out_10_plus_72h":e==="shell_chain"?"layered_shell_3_hops":e,he={},O=Array.from(N.entries()).map(([e,t])=>{const n=Array.from(t).reduce((E,C)=>C==="cycle"?E+40:C==="shell_chain"?E+35:C==="fan_in"||C==="fan_out"?E+25:E,0),s=Math.max(0,t.size-1)*5,i=Math.min(100,n+s),r=Array.from(t).map(xe).sort(),a=H.get(e),S=[`Account: ${e}`,`Detected patterns: ${r.join(", ")||"none"}`,`Ring ID: ${a?a.ring_id:"RING_000"}`,`Score formula: base(${n}) + bonus(${s}) = ${Math.min(100,n+s)}`].join(`
`);return he[e]=S,{account_id:e,suspicion_score:Number(i.toFixed(1)),detected_patterns:r,ring_id:a?a.ring_id:"RING_000"}});O.sort((e,t)=>t.suspicion_score-e.suspicion_score);const u=new Map;o.forEach(e=>{u.set(e,{credits:0,debits:0,net:0,rings:[],smurfs:[],shells:[],minTime:1/0,maxTime:-1/0})}),c.forEach(e=>{const t=u.get(e.sender),n=u.get(e.receiver);t&&(t.debits+=1,t.net-=e.amount,Number.isFinite(e.timestamp)&&(t.minTime=Math.min(t.minTime,e.timestamp),t.maxTime=Math.max(t.maxTime,e.timestamp))),n&&(n.credits+=1,n.net+=e.amount,Number.isFinite(e.timestamp)&&(n.minTime=Math.min(n.minTime,e.timestamp),n.maxTime=Math.max(n.maxTime,e.timestamp)))}),T.forEach(e=>{e.pattern_type==="cycle"&&e.member_accounts.forEach(t=>{const n=u.get(t);n&&n.rings.push(e.ring_id)})}),Array.from(x.entries()).sort((e,t)=>e[0].localeCompare(t[0])).forEach(([e,t],n)=>{const s=`SMURF_IN_${String(n+1).padStart(3,"0")}`,i=u.get(e);i&&i.smurfs.push(s),t.forEach(r=>{const a=u.get(r);a&&a.smurfs.push(s)})}),Array.from(I.entries()).sort((e,t)=>e[0].localeCompare(t[0])).forEach(([e,t],n)=>{const s=`SMURF_OUT_${String(n+1).padStart(3,"0")}`,i=u.get(e);i&&i.smurfs.push(s),t.forEach(r=>{const a=u.get(r);a&&a.smurfs.push(s)})}),q.map(e=>e.join("|")).sort().map((e,t)=>({key:e,id:`SHELL_${String(t+1).padStart(3,"0")}`})).forEach(e=>{e.key.split("|").forEach(n=>{const s=u.get(n);s&&s.shells.push(e.id)})});const pe=new Map;O.forEach(e=>{pe.set(e.account_id,e.suspicion_score)});const ge={};u.forEach((e,t)=>{ge[t]={name:t,suspicion_score:pe.get(t)??0,net_balance:Number(e.net.toFixed(2)),credits:e.credits,debits:e.debits,rings:e.rings,smurfs:e.smurfs,shells:e.shells,rings_count:e.rings.length,first_txn:Number.isFinite(e.minTime)?new Date(e.minTime).toISOString():null,last_txn:Number.isFinite(e.maxTime)?new Date(e.maxTime).toISOString():null}});const R=new Map;b.forEach(e=>{const t=`${e.sender_id}→${e.receiver_id}`,n=Number.parseFloat(e.amount||"0")||0,s=e.timestamp?Date.parse(e.timestamp):NaN;R.has(t)||R.set(t,{net:0,minTime:1/0,maxTime:-1/0,count:0});const i=R.get(t);i.net+=n,i.count+=1,Number.isFinite(s)&&(i.minTime=Math.min(i.minTime,s),i.maxTime=Math.max(i.maxTime,s))});const _e={};R.forEach((e,t)=>{_e[t]={net:Number(e.net.toFixed(2)),count:e.count,first_txn:Number.isFinite(e.minTime)?new Date(e.minTime).toISOString():null,last_txn:Number.isFinite(e.maxTime)?new Date(e.maxTime).toISOString():null}});const ye={suspicious_accounts:O,suspicion_explanations:he,node_details:ge,edge_details:_e,fraud_rings:T,ring_displays:ue,summary:{total_accounts_analyzed:o.length,suspicious_accounts_flagged:O.length,fraud_rings_detected:T.length,processing_time_seconds:0}},we=performance.now()-f;ye.summary.processing_time_seconds=Number((we/1e3).toFixed(1)),J&&J(b.length);const Se=new Map,Ie={nodes:o.map(e=>({id:e,label:e})),edges:b.map((e,t)=>{const n=e.transaction_id||`edge-${t}`,s=(Se.get(n)??0)+1;return Se.set(n,s),{id:s>1?`${n}-${s}`:n,source:e.sender_id,target:e.receiver_id,label:e.amount?`Amount: ${e.amount}`:void 0,timestamp:e.timestamp}}),classes:be,rings:G,smurfing:{fanIn:P,fanOut:W},layered:B,counts:{rings:G.length,smurfing:P.length+W.length,layered:B.length},analysisMs:we,analysisPayload:ye};K.postMessage(Ie)}catch(g){K.postMessage({error:g instanceof Error?g.message:"Analysis failed",analysisMs:performance.now()-f})}};
