const Ee=d=>{const _=d.trim().split(/\r?\n/).filter(Boolean);if(_.length<2)return[];const h=_[0].split(",").map(r=>r.trim()),M=h.indexOf("sender_id"),R=h.indexOf("receiver_id"),f=h.indexOf("transaction_id"),E=h.indexOf("amount"),m=h.indexOf("timestamp");return M===-1||R===-1?[]:_.slice(1).map(r=>{const c=r.split(",").map(y=>y.trim());return{transaction_id:c[f]??"",sender_id:c[M]??"",receiver_id:c[R]??"",amount:c[E]??"",timestamp:c[m]??""}})},B=self;let q=null,H=null,K=null,J=null,Q=null,O=null;const xe=async()=>(q||(q=(async()=>{const d=await import("./muling_wasm-BT_7aCSW.js");await d.default(),H=d.analyze_stub,K=d.detect_fan_in,J=d.detect_fan_out,Q=d.detect_cycles,O=d.detect_shell_chains})()),q);B.onmessage=async d=>{const _=performance.now(),{csvText:h,rows:M,source:R="abc.csv"}=d.data;try{await xe();const f=(M??Ee(h??"")).filter(e=>e.sender_id&&e.receiver_id),E=new Set,m=[];f.forEach(e=>{E.add(e.sender_id),E.add(e.receiver_id),m.push({sender:e.sender_id,receiver:e.receiver_id,amount:Number.parseFloat(e.amount||"0")||0,timestamp:e.timestamp?Date.parse(e.timestamp):NaN})});const r=Array.from(E),c=new Map,y=new Map,A=new Map;r.forEach(e=>{c.set(e,0),y.set(e,new Set),A.set(e,new Set)}),m.forEach(e=>{var t,n,s,i;if(c.set(e.sender,(c.get(e.sender)??0)+1),c.set(e.receiver,(c.get(e.receiver)??0)+1),(t=A.get(e.sender))==null||t.add(e.receiver),(n=A.get(e.receiver))==null||n.add(e.sender),Number.isFinite(e.timestamp)){const a=new Date(e.timestamp).toISOString().slice(0,10);(s=y.get(e.sender))==null||s.add(a),(i=y.get(e.receiver))==null||i.add(a)}});const D=[...m.map(e=>e.amount).filter(e=>Number.isFinite(e))].sort((e,t)=>e-t),V=D.length===0?0:D[Math.floor(D.length/2)],X=V>0?V*.5:0,l=e=>{var i,a;const t=c.get(e)??0,n=((i=A.get(e))==null?void 0:i.size)??0,s=((a=y.get(e))==null?void 0:a.size)??0;return t>=200&&n>=50&&s>=20},C=new Map;r.forEach((e,t)=>C.set(e,t));const x=new Uint32Array(m.length),b=new Uint32Array(m.length),k=new Float64Array(m.length),j=new Float64Array(m.length),Y=new Uint32Array(r.length);m.forEach((e,t)=>{x[t]=C.get(e.sender)??0,b[t]=C.get(e.receiver)??0,k[t]=e.timestamp,j[t]=e.amount}),r.forEach((e,t)=>{Y[t]=c.get(e)??0});const Z=new Set,L=[],ee=[];if(Q){const e=Q(r.length,x,b,3,5,1500,60);let t=[];for(let n=0;n<e.length;n+=1){const s=e[n];if(s===4294967295){t.length>=3&&(t.forEach(a=>Z.add(a)),t.some(a=>l(a))||(L.push(`${t.join(" → ")} → ${t[0]}`),ee.push([...t]))),t=[];continue}t.push(r[s])}}const te=new Set,ne=new Set,z=[],U=[],se=4320*60*1e3,w=new Map,S=new Map;if(K&&J){const e=K(r.length,x,b,k,j,X,se,10),t=J(r.length,x,b,k,j,X,se,10);for(let n=0;n<e.length;n+=2){const s=r[e[n]],i=r[e[n+1]];w.has(s)||w.set(s,new Set),w.get(s).add(i)}w.forEach((n,s)=>{l(s)||(te.add(s),z.push(`${s} ← ${Array.from(n).join(", ")}`))});for(let n=0;n<t.length;n+=2){const s=r[t[n]],i=r[t[n+1]];S.has(s)||S.set(s,new Set),S.get(s).add(i)}S.forEach((n,s)=>{l(s)||(ne.add(s),U.push(`${s} → ${Array.from(n).join(", ")}`))})}const ie=new Set,re=new Set,ae=new Set,oe=new Set,G=[];if(!O)throw new Error("WASM shell detection not loaded. Rebuild WASM.");const P=[];if(O){const e=O(r.length,x,b,Y,5,2e3,60);let t=[];for(let n=0;n<e.length;n+=1){const s=e[n];if(s===4294967295){if(t.length>=4){const i=t.slice(1,-1);if(!i.some(o=>l(o))){i.forEach((p,g)=>{g===0?ie.add(p):g===1?re.add(p):ae.add(p)});const o=`${t.join(" → ")}`;oe.has(o)||(oe.add(o),G.push(o),P.push([...t]))}}t=[];continue}t.push(r[s])}}const ye={cycle:Array.from(Z).filter(e=>!l(e)),fanIn:Array.from(te).filter(e=>!l(e)),fanOut:Array.from(ne).filter(e=>!l(e)),stage1:Array.from(ie).filter(e=>!l(e)),stage2:Array.from(re).filter(e=>!l(e)),stage3:Array.from(ae).filter(e=>!l(e))},I=[],ce=new Set,me=[],T=(e,t,n,s)=>{const i=t.filter(p=>!l(p));if(i.length===0)return;const a=[...new Set(i)].sort(),o=`${e}:${a.join("|")}`;ce.has(o)||(ce.add(o),me.push({key:o,pattern:e,members:a,base:n,display:s}))};ee.forEach(e=>T("cycle",e,90,`${e.join(" → ")} → ${e[0]}`)),P.forEach(e=>T("shell_chain",e,85)),w.forEach((e,t)=>T("fan_in",[t,...e],70)),S.forEach((e,t)=>T("fan_out",[t,...e],70));const le={};me.sort((e,t)=>e.pattern===t.pattern?e.key.localeCompare(t.key):e.pattern.localeCompare(t.pattern)).forEach((e,t)=>{const n=`RING_${String(t+1).padStart(3,"0")}`;I.push({ring_id:n,member_accounts:e.members,pattern_type:e.pattern,risk_score:Math.min(100,e.base+Math.min(20,e.members.length*2))}),e.display&&(le[n]=e.display)});const $=new Map,W=new Map;I.forEach(e=>{e.member_accounts.forEach(t=>{$.has(t)||$.set(t,new Set),$.get(t).add(e.pattern_type);const n=W.get(t);(!n||e.risk_score>n.risk)&&W.set(t,{ring_id:e.ring_id,risk:e.risk_score})})});const we=e=>e==="cycle"?"cycle_length_3_5":e==="fan_in"?"fan_in_10_plus_72h":e==="fan_out"?"fan_out_10_plus_72h":e==="shell_chain"?"layered_shell_3_hops":e,de={},F=Array.from($.entries()).map(([e,t])=>{const n=Array.from(t).reduce((g,N)=>N==="cycle"?g+40:N==="shell_chain"?g+35:N==="fan_in"||N==="fan_out"?g+25:g,0),s=Math.max(0,t.size-1)*5,i=Math.min(100,n+s),a=Array.from(t).map(we).sort(),o=W.get(e),p=[`Account: ${e}`,`Detected patterns: ${a.join(", ")||"none"}`,`Ring ID: ${o?o.ring_id:"RING_000"}`,`Score formula: base(${n}) + bonus(${s}) = ${Math.min(100,n+s)}`].join(`
`);return de[e]=p,{account_id:e,suspicion_score:Number(i.toFixed(1)),detected_patterns:a,ring_id:o?o.ring_id:"RING_000"}});F.sort((e,t)=>t.suspicion_score-e.suspicion_score);const u=new Map;r.forEach(e=>{u.set(e,{credits:0,debits:0,net:0,rings:[],smurfs:[],shells:[],minTime:1/0,maxTime:-1/0})}),m.forEach(e=>{const t=u.get(e.sender),n=u.get(e.receiver);t&&(t.debits+=1,t.net-=e.amount,Number.isFinite(e.timestamp)&&(t.minTime=Math.min(t.minTime,e.timestamp),t.maxTime=Math.max(t.maxTime,e.timestamp))),n&&(n.credits+=1,n.net+=e.amount,Number.isFinite(e.timestamp)&&(n.minTime=Math.min(n.minTime,e.timestamp),n.maxTime=Math.max(n.maxTime,e.timestamp)))}),I.forEach(e=>{e.pattern_type==="cycle"&&e.member_accounts.forEach(t=>{const n=u.get(t);n&&n.rings.push(e.ring_id)})}),Array.from(w.entries()).sort((e,t)=>e[0].localeCompare(t[0])).forEach(([e,t],n)=>{const s=`SMURF_IN_${String(n+1).padStart(3,"0")}`,i=u.get(e);i&&i.smurfs.push(s),t.forEach(a=>{const o=u.get(a);o&&o.smurfs.push(s)})}),Array.from(S.entries()).sort((e,t)=>e[0].localeCompare(t[0])).forEach(([e,t],n)=>{const s=`SMURF_OUT_${String(n+1).padStart(3,"0")}`,i=u.get(e);i&&i.smurfs.push(s),t.forEach(a=>{const o=u.get(a);o&&o.smurfs.push(s)})}),P.map(e=>e.join("|")).sort().map((e,t)=>({key:e,id:`SHELL_${String(t+1).padStart(3,"0")}`})).forEach(e=>{e.key.split("|").forEach(n=>{const s=u.get(n);s&&s.shells.push(e.id)})});const ue=new Map;F.forEach(e=>{ue.set(e.account_id,e.suspicion_score)});const fe={};u.forEach((e,t)=>{fe[t]={name:t,suspicion_score:ue.get(t)??0,net_balance:Number(e.net.toFixed(2)),credits:e.credits,debits:e.debits,rings:e.rings,smurfs:e.smurfs,shells:e.shells,rings_count:e.rings.length,first_txn:Number.isFinite(e.minTime)?new Date(e.minTime).toISOString():null,last_txn:Number.isFinite(e.maxTime)?new Date(e.maxTime).toISOString():null}});const v=new Map;f.forEach(e=>{const t=`${e.sender_id}→${e.receiver_id}`,n=Number.parseFloat(e.amount||"0")||0,s=e.timestamp?Date.parse(e.timestamp):NaN;v.has(t)||v.set(t,{net:0,minTime:1/0,maxTime:-1/0,count:0});const i=v.get(t);i.net+=n,i.count+=1,Number.isFinite(s)&&(i.minTime=Math.min(i.minTime,s),i.maxTime=Math.max(i.maxTime,s))});const he={};v.forEach((e,t)=>{he[t]={net:Number(e.net.toFixed(2)),count:e.count,first_txn:Number.isFinite(e.minTime)?new Date(e.minTime).toISOString():null,last_txn:Number.isFinite(e.maxTime)?new Date(e.maxTime).toISOString():null}});const pe={suspicious_accounts:F,suspicion_explanations:de,node_details:fe,edge_details:he,fraud_rings:I,ring_displays:le,summary:{total_accounts_analyzed:r.length,suspicious_accounts_flagged:F.length,fraud_rings_detected:I.length,processing_time_seconds:0}},ge=performance.now()-_;pe.summary.processing_time_seconds=Number((ge/1e3).toFixed(1)),H&&H(f.length);const _e=new Map,Se={nodes:r.map(e=>({id:e,label:e})),edges:f.map((e,t)=>{const n=e.transaction_id||`edge-${t}`,s=(_e.get(n)??0)+1;return _e.set(n,s),{id:s>1?`${n}-${s}`:n,source:e.sender_id,target:e.receiver_id,label:e.amount?`Amount: ${e.amount}`:void 0,timestamp:e.timestamp}}),classes:ye,rings:L,smurfing:{fanIn:z,fanOut:U},layered:G,counts:{rings:L.length,smurfing:z.length+U.length,layered:G.length},analysisMs:ge,analysisPayload:pe};B.postMessage(Se)}catch(f){B.postMessage({error:f instanceof Error?f.message:"Analysis failed",analysisMs:performance.now()-_})}};
